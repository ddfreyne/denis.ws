#!/usr/bin/env ruby

### Preprocessing rules

preprocess do
  def set_mix_dates
    mixes = items.find { |i| i.identifier == '/mixes/' }.children
    mixes.each do |mix|
      mix.identifier =~ %r{/(\d{4}-\d{2}-\d{2})/$}
      mix[:created_on] = Date.parse($1)
    end
  end

  set_mix_dates
end

### Compilation rules

compile '/assets/style/*' do
  filter :rainpress
end

compile '/journal/feed_private/' do
  filter :erb
  # no layout because it's not HTML
  # no rubypants because it's not HTML
end

compile '/sitemap_xml/' do
  filter :erb
  # no layout because it's not HTML
  # no rubypants because it's not HTML
end

compile '/404/' do
  filter :erb
  # no layout because that is rendered by the page itself
  # no rubypants because it messed up the PHP
end

compile '/mixes/200*', :rep => :cue do
  filter :setlist_to_cue
end

%w[ links tweets tracks mixes ].each do |type|
  pattern = "/#{type}/*/"
  compile pattern do
    if item.parent.identifier == '/'
      filter :erb
      layout 'default'
      filter :rubypants
    end
  end
end

compile '/' do
  filter :erb
  layout 'default'
  filter :rubypants
end

compile '*' do
  if item[:markdown]
    filter :original_markdown
  else
    filter :erb
  end

  layout 'default'
  filter :rubypants
end

### Routing rules

route '/404/' do
  '/error/404.php'
end

route '/journal/feed_private/' do
  '/journal/feed_private/index.xml'
end

route '/sitemap_xml/' do
  '/sitemap.xml'
end

route '/assets/*' do
  # path with version
  item.identifier[0..-2] + '-v' + item[:version].to_s + '.css'
end

route '/mixes/200*', :rep => :cue do
  item.identifier.chop + '.cue'
end

%w[ links tweets tracks mixes ].each do |type|
  pattern = "/#{type}/*/"
  route pattern do
    if item.parent.identifier == '/'
      item.identifier + 'index.html'
    else
      nil
    end
  end
end

route '*' do
  item.identifier + 'index.html'
end

### Layouting rules

layout '*', :erb
