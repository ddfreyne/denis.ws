#!/usr/bin/env ruby

### Preprocessing rules ######################################################

preprocess do
  def hide_specials
    items.each do |item|
      if item.identifier =~ /^\/(assets|well-known|robots\.txt)/
        item[:is_hidden] = true
      end
    end
  end

  def delete_drafts
    items.delete_if { |i| i[:is_draft] }
  end

  def convert_dates
    items.each do |i|
      i[:published_on] = Date.parse(i[:published_on]) if i[:published_on]
    end
  end

  def assign_cachebuster_id
    stylesheet = @items['/assets/style/style.*']
    digest = Digest::SHA1.base64digest(stylesheet.raw_content)
    stylesheet[:cbid] = digest.gsub(/[^A-Za-z0-9]+/, '')
  end

  hide_specials
  delete_drafts
  convert_dates
  assign_cachebuster_id
end

### Compilation + routing rules ##############################################

compile '/404.*' do
  layout '/default.*'
  write '/404.html'
end

compile '/sitemap_xml.*' do
  filter :erb
  write '/sitemap.xml'
end

passthrough '/favicon.*'
passthrough '/robots.*'

compile '/well-known/**/*' do
  write item.identifier.to_s.sub(/^\//, '/.')
end

compile '/assets/style/*' do
  filter :sass, syntax: :scss, style: :compressed
  filter :relativize_paths, type: :css

  cbid_part = item[:cbid] ? '-' + item[:cbid] : ''
  write item.identifier.without_ext + cbid_part + '.css'
end

passthrough '/assets/**/*'

compile '/**/*' do
  next if item[:is_partial]

  filter :rdiscount if item.identifier.ext == 'md'
  filter :erb if item[:is_dynamic]

  if item[:has_code]
    filter :colorize_syntax, syntax: :html5, default_colorizer: :pygmentsrb
  end

  layout '/default.*'

  filter :rubypants
  filter :relativize_paths, type: :html5

  if item.identifier =~ '/index.*'
    write '/index.html'
  elsif !item[:is_partial]
    write item.identifier.without_exts + '/index.html'
  end
end

### Layouting rules ##########################################################

layout '/**/*', :erb
