#!/usr/bin/env ruby

### Preprocessing rules ######################################################

preprocess do

  def hide_assets
    items.each do |item|
      if item.identifier =~ /^\/assets/
        item[:is_hidden] = true
      end
    end
  end

  def delete_drafts
    items.delete_if { |i| i[:is_draft] }
  end

  def convert_dates
    items.each do |i|
      if i[:published_on]
        i[:published_on] = Date.parse(i[:published_on])
      end
    end
  end

  def assign_cachebuster_id
    stylesheet = @items["/assets/style/style/"]
    stylesheet[:cbid] = stylesheet.raw_content.checksum.gsub(/[^a-zA-Z0-9]/, '_')
  end

  hide_assets
  delete_drafts
  convert_dates
  assign_cachebuster_id
end

### Compilation + routing rules ##############################################

# 404

compile '/404/' do
  layout 'page'
  layout 'default'
end

route '/404/' do
  '/404.html'
end

# sitemap

compile '/sitemap_xml/' do
  filter :erb
end

route '/sitemap_xml/' do
  '/sitemap.xml'
end

# favicon

compile '/favicon/' do
end

passthrough '/favicon/'

# assets

compile '/assets/style/*/' do
  filter :sass, :syntax => :scss, :style => :compressed
  filter :relativize_paths, :type => :css
end

compile '/assets/*/' do
end

route '/assets/*/' do
  cbid_part = item[:cbid] ? '-' + item[:cbid] : ''
  item.identifier.chop + cbid_part + '.' + item[:extension]
end

# other

compile '*' do
  next if item[:is_partial]

  if item[:markdown]
    filter :rdiscount
  end

  if item[:is_dynamic]
    filter :erb
  end

  if item[:has_code]
    filter :colorize_syntax, :default_colorizer => :pygmentsrb
  end

  case @item[:kind]
  when 'review'
    layout 'review'
  else
    layout 'page'
  end
  layout 'default'

  filter :rubypants
  filter :relativize_paths, :type => :html
end

route '*' do
  if item[:is_partial]
    nil
  else
    item.identifier + 'index.html'
  end
end

### Layouting rules ##########################################################

layout '*', :erb
