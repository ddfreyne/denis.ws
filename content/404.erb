---
title:     "<?php if($is_gone) { ?>Page Is Gone<?php } else { ?>Page Not Found<?php } ?>"
is_hidden: "true"
---

<?php

########## CONFIGURATION #####################################################

// E-mail settings
$src_email_address = 'webmaster@stoneship.org';
$dst_email_address = 'denis.defreyne@stoneship.org';

// The name of the site
$site_name = 'Stoneship';

// Send HTTP status code 410s or simply 404s?
$send_410s = false;

// Should a mail be sent if the requested page is gone?
$send_mail_if_gone        = false;

// Should a mail be sent if there is no referrer?
$send_mail_if_no_referrer = false;

// The list of pages that are considered "gone"
$gone_pages = array(
	'@^/blog(/.*$|$)@',
	'@^/pub/music/Denis@'
);

########## DO NOT CHANGE BELOW THIS LINE #####################################

// Get path and URL of this page
$this_path = $_SERVER['REQUEST_URI'];
$this_url  = 'http://' . $_SERVER['SERVER_NAME'] . $this_path;

// Check whether the page existed before
$is_gone = false;
foreach($gone_pages as $gone_page)
{
	if(preg_match($gone_page, $this_path) > 0)
	{
		$is_gone = true;
		break;
	}
}

// Check whether page has referrer
$has_referrer = isset($_SERVER['HTTP_REFERER']);

// Send mail if necessary
$should_send_mail = true;
if($is_gone && !$send_mail_if_gone)
	$should_send_mail = false;
else if(!$has_referrer && !$send_mail_if_no_referrer)
	$should_send_mail = false;
if($should_send_mail)
{
	$subject = '404 @ ' . $site_name . ': ' . $_SERVER['SERVER_NAME'] . $_SERVER['REQUEST_URI'];
	$message = 'The following URL caused a 404 error on ' . $site_name . ':' . "\n\n" .
		'URL:      ' . 'http://' . $_SERVER['SERVER_NAME'] . $_SERVER['REQUEST_URI'] . "\n" .
		'Referrer: ' . $_SERVER['HTTP_REFERER'];
	$headers = 'From: ' . $src_email_address;

	mail($dst_email_address, $subject, $message, $headers);
}

// Serve correct HTTP status code
if($is_gone && $send_410s)
	header('HTTP/1.1 410 Gone');
else
	header('HTTP/1.1 404 Not Found');

?><% render 'default' do %>

<%# general message %>
<?php if($is_gone) { ?>
<p>Unfortunately, the page you requested, <?php echo $this_url; ?>, is no longer available on this web site.</p>
<?php } else { ?>
<p>Unfortunately, the page you requested, <?php echo $this_url; ?>, was not found on this website. If you typed the address in manually, please double-check it to make sure it is correct. You may also want to take a look at the <a href="/sitemap/">site map</a> to find what you're looking for.</p>
<?php } ?>

<%# blog-specific message %>
<?php if (preg_match('@^/blog(/.*$|$)@', $this_path) > 0) { ?>
<p>My old blog has been taken offline, and only the <a href="/journal/2005/using-a-nsoutlineview-as-a-source-list/">Using a NSOutlineView as a Source List</a> article survived. Please check out my <a href="/journal/">new blog</a> for more up-to-date articles.</p>
<?php } ?>

<% end %>
